{% block title %}
    Results
{% endblock %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Ergebnisse</title>
</head>
<body>
    <video id="videoPlayer" width="640" height="360" controls>
        Ihr Browser unterst√ºtzt das Video-Tag nicht.
    </video>

    <input type="file" id="videoInput" accept="video/*">
    <div id="results">
        <div id="mean_pitch" class="result-box">Mean Pitch: <span id="mean_pitch_value"></span></div>
        <div id="std_pitch" class="result-box">Standard Deviation of Pitch: <span id="std_pitch_value"></span></div>
        <div id="hnr" class="result-box">Harmonicity (HNR): <span id="hnr_value"></span></div>
        <div id="zcr" class="result-box">Zero Crossing Rate: <span id="zcr_value"></span></div>
    </div>

    <script>
        let analysisData = {};

        async function fetchResults() {
            try {
                const response = await fetch('/static/global/audio_analysis.json'); // Ensure this path is correct
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                analysisData = await response.json();
                console.log('Audio analysis data:', analysisData); // Log data to verify
            } catch (error) {
                console.error('Error fetching audio analysis:', error);
            }
        }

        document.getElementById('videoInput').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file) {
                var videoPlayer = document.getElementById('videoPlayer');
                var fileURL = URL.createObjectURL(file);
                videoPlayer.src = fileURL;
                videoPlayer.load();
                videoPlayer.play();

                var formData = new FormData();
                formData.append('videoFile', file);

                fetch('/upload_video', {
                    method: 'POST',
                    body: formData
                }).then(response => response.json())
                .then(data => {
                    console.log('Video file uploaded successfully', data);
                }).catch(error => {
                    console.error('Error uploading video file', error);
                });
            }
        });

        document.getElementById('videoPlayer').addEventListener('timeupdate', function() {
            var videoPlayer = document.getElementById('videoPlayer');
            var currentTime = Math.floor(videoPlayer.currentTime / 5) * 5; // Round to the nearest 5 seconds
            if (analysisData[currentTime]) {
                document.getElementById('mean_pitch_value').innerText = analysisData[currentTime].mean_pitch;
                document.getElementById('std_pitch_value').innerText = analysisData[currentTime].std_pitch;
                document.getElementById('hnr_value').innerText = analysisData[currentTime].hnr;
                document.getElementById('zcr_value').innerText = analysisData[currentTime].zcr;
            } else {
                document.getElementById('mean_pitch_value').innerText = "N/A";
                document.getElementById('std_pitch_value').innerText = "N/A";
                document.getElementById('hnr_value').innerText = "N/A";
                document.getElementById('zcr_value').innerText = "N/A";
            }
        });

        // Call fetchResults when the page loads
        fetchResults();
    </script>
</body>
{% endblock %}
