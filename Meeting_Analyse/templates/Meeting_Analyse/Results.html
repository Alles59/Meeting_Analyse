{% block title %}
    Ergebnisse
{% endblock %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Ergebnisse</title>
</head>
<body>
    <video id="videoPlayer" width="640" height="360" controls>
        Ihr Browser unterstützt das Video-Tag nicht.
    </video>

    <input type="file" id="videoInput" accept="video/*">
    <div id="results">
        <div id="mean_pitch" class="result-box">Mean Pitch: <span id="mean_pitch_value"></span></div>
        <div id="std_pitch" class="result-box">Standard Deviation of Pitch: <span id="std_pitch_value"></span></div>
        <div id="hnr" class="result-box">Harmonicity (HNR): <span id="hnr_value"></span></div>
        <div id="zcr" class="result-box">Zero Crossing Rate: <span id="zcr_value"></span></div>
    </div>

    <script>
        let analysisData = {};

        async function fetchResults() {
            const randomParam = Math.floor(Math.random() * 1000000); // Zufälligen Parameter hinzufügen
            const url = `/static/global/audio_analysis.json?random=${randomParam}`;
            try {
                const response = await fetch(url); // Korrekte Pfadangabe
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                analysisData = await response.json();
                console.log('Audioanalyse-Daten:', analysisData); // Daten zur Überprüfung ausgeben
            } catch (error) {
                console.error('Fehler beim Abrufen der Audioanalyse:', error);
            }
        }

        function updateResults() {
            var videoPlayer = document.getElementById('videoPlayer');
            var currentTime = Math.floor(videoPlayer.currentTime / 5) * 5; // Auf die nächsten 5 Sekunden runden
            console.log('Aktuelle Zeit:', currentTime); // Ausgabe des aktuellen Zeitstempels
            if (analysisData[currentTime]) {
                console.log('Daten für aktuellen Zeitstempel:', analysisData[currentTime]); // Ausgabe der Daten für den aktuellen Zeitstempel
                document.getElementById('mean_pitch_value').innerText = analysisData[currentTime].mean_pitch;
                document.getElementById('std_pitch_value').innerText = analysisData[currentTime].std_pitch;
                document.getElementById('hnr_value').innerText = analysisData[currentTime].hnr;
                document.getElementById('zcr_value').innerText = analysisData[currentTime].zcr;
            } else {
                console.log('Keine Daten für aktuellen Zeitstempel vorhanden.'); // Fehlermeldung wenn keine Daten vorhanden
                document.getElementById('mean_pitch_value').innerText = "N/A";
                document.getElementById('std_pitch_value').innerText = "N/A";
                document.getElementById('hnr_value').innerText = "N/A";
                document.getElementById('zcr_value').innerText = "N/A";
            }
        }

        document.getElementById('videoInput').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file) {
                var videoPlayer = document.getElementById('videoPlayer');
                var fileURL = URL.createObjectURL(file);
                videoPlayer.src = fileURL;
                videoPlayer.load();
                videoPlayer.play();

                // Start fetching results periodically
                setInterval(fetchResults, 5000); // Alle 5 Sekunden Ergebnisse abrufen
            }
        });

        document.getElementById('videoPlayer').addEventListener('timeupdate', function() {
            updateResults();
        });

        // Initialer Aufruf, um sicherzustellen, dass die Daten beim Laden der Seite abgerufen werden
        fetchResults();
    </script>
</body>
{% endblock %}
